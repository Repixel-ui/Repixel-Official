import gradio as gr
from atelier_generator import AtelierGenerator

client = AtelierGenerator(gradio=True, wm_text="Anime Image Generator! by Repixel")

gr_css = """
footer {
    display: none !important;
}
.image-frame.svelte-rrgd5g img {
    height: 100%;
    width: 100%;
    object-fit: contain;
}
.grid-wrap.svelte-eynlr2.svelte-eynlr2 {
    overflow-y: auto;
    height: 100% !important;
}
.upload-panel {
    height: 100%;
    display: flex;
    flex-direction: column;
}
.gallery-panel {
    height: 100%;
}
.gallery-container {
    height: calc(100% - 60px) !important;
}
.beta-feature {
    background: linear-gradient(135deg, #ff000030, #0000ff30);
    border: 1px solid #ff000050;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}
.webview-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #0F0F0F;
    z-index: 1000;
    display: none;
}
.webview-header {
    padding: 15px;
    background: #0F0F0F;
    border-bottom: 1px solid #ff000050;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.webview-content {
    height: calc(100% - 60px);
    width: 100%;
}
"""

gr_thm = gr.themes.Default(
            primary_hue=gr.themes.colors.rose,
            secondary_hue=gr.themes.colors.rose,
            neutral_hue=gr.themes.colors.zinc
        )

# Initialize a cache dictionary outside the function
caption_cache = {}

def AnimeGenerator(src, mem, progress=gr.Progress()):
    progress(0.1, "Preparing image (stage 1 of 3)...")
    size, _, _ = client.size_checker(src)

    # Check if the caption is already cached
    if src in caption_cache:      
        prompt = caption_cache[src]
    else:
        progress(0.5, f"Processing {size} image (stage 2 of 3)...")
        prompt = client.image_caption(src)
        caption_cache[src] = prompt

    progress(0.8, f"Rendering {size} image (stage 3 of 3)...")
    # Always use anime-plus style
    result = client.image_variation(
        src, 
        prompt, 
        image_size=size, 
        strength=0.33, 
        lora_flux='anime-plus'
    )
    
    if result:
        mem.insert(0, result)
        return mem
    else:
        gr.Warning('Something went wrong! Please try again.')
        return mem

with gr.Blocks(analytics_enabled=False, title='Anime Image Generator by repixel', css=gr_css, theme=gr_thm) as demo:
    gr.Markdown("## <br><center>Anime Image Generator - Transform your images to anime style!")
    
    # Beta Features Section
    with gr.Column(variant="panel", elem_classes="beta-feature"):
        gr.Markdown("## <center>ðŸš€ Beta Feature Preview")
        gr.Markdown("""
        <center>We're testing a new full-screen experience with enhanced capabilities!
        <br>Try our beta webview interface that includes:
        <br>- Full-screen image processing
        <br>- Direct download functionality
        <br>- Improved gallery selection
        """)
        open_webview = gr.Button("Try Beta Version", variant="primary")
    
    with gr.Row(equal_height=True):
        with gr.Column():
            with gr.Column(variant='panel', elem_classes="upload-panel"):
                gr.Markdown("## <center>ðŸ“¸ Upload Your Image!")
                src = gr.Image(type='filepath', label='', height="100%", sources=['upload'])
                run = gr.Button("Generate Anime Image!", variant='stop')

        with gr.Column():    
            with gr.Column(variant='panel', elem_classes="gallery-panel"):
                gr.Markdown("## <center>ðŸŽ¨ Generated Result")
                res = gr.Gallery(
                    label='', 
                    height="100%",
                    elem_classes="gallery-container",
                    preview=True,
                    columns=1,
                    object_fit="contain"
                )
                mem = gr.State([])

    # Webview Section (hidden by default)
    with gr.Column(visible=False, elem_classes="webview-container") as webview:
        with gr.Column(elem_classes="webview-header"):
            gr.Markdown("### Beta Webview Interface")
            close_webview = gr.Button("Close", variant="stop")
        
        with gr.Column(elem_classes="webview-content"):
            with gr.Row():
                with gr.Column():
                    webview_src = gr.Image(type='filepath', label='Upload Image', height=500, sources=['upload'])
                    webview_run = gr.Button("Process Image", variant='primary')
                
                with gr.Column():
                    webview_res = gr.Gallery(label='Results', height=500)
                    webview_download = gr.Button("Download Results", variant='secondary')
                    webview_mem = gr.State([])

    # Event handlers
    run.click(
        inputs=[src, mem],
        outputs=res,
        fn=AnimeGenerator
    )
    
    webview_run.click(
        inputs=[webview_src, webview_mem],
        outputs=webview_res,
        fn=AnimeGenerator
    )
    
    def toggle_webview():
        return gr.update(visible=True)
    
    def close_webview_fn():
        return gr.update(visible=False)
    
    open_webview.click(
        fn=toggle_webview,
        outputs=webview
    )
    
    close_webview.click(
        fn=close_webview_fn,
        outputs=webview
    )
    
    # Download functionality
    def download_images(images):
        if images:
            return gr.update(value=images, visible=True)
        return gr.update(visible=False)
    
    webview_download.click(
        fn=download_images,
        inputs=webview_res,
        outputs=gr.File(label="Download Results", visible=False)
    )

demo.launch(inbrowser=True)
